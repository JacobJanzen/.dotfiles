#+title: Emacs Configuration

#+begin_src nix
  { config, pkgs, ... }:

  {
    home.file = {
      "./.config/emacs/feed.org".source = ./feed.org;
      "./.config/emacs/init.el".source = ./init.el;
      "./.config/emacs/force-custom-file.el".source = ./force-custom-file.el;
      "./.config/emacs/package-setup.el".source = ./package-setup.el;
      "./.config/emacs/user-interface.el".source = ./user-interface.el;
      "./.config/emacs/tools.el".source = ./tools.el;
      "./.config/emacs/languages.el".source = ./languages.el;
    };

    nixpkgs.overlays = [
      (final: prev:
        {
          emacs29-pgtk = prev.emacs29-pgtk.overrideAttrs (old: {
            patches =
          (old.patches or [])
          ++ [
            # Fix OS window role (needed for window managers like yabai)
            (prev.fetchpatch {
              url = "https://raw.githubusercontent.com/d12frosted/homebrew-emacs-plus/master/patches/emacs-28/fix-window-role.patch";
              sha256 = "sha256-+z/KfsBm1lvZTZNiMbxzXQGRTjkCFO4QPlEK35upjsE=";
            })
            # Enable rounded window with no decoration
            (prev.fetchpatch {
              url = "https://raw.githubusercontent.com/d12frosted/homebrew-emacs-plus/master/patches/emacs-29/round-undecorated-frame.patch";
              sha256 = "sha256-uYIxNTyfbprx5mCqMNFVrBcLeo+8e21qmBE3lpcnd+4=";
            })
            # Make Emacs aware of OS-level light/dark mode
            (prev.fetchpatch {
              url = "https://raw.githubusercontent.com/d12frosted/homebrew-emacs-plus/master/patches/emacs-28/system-appearance.patch";
              sha256 = "sha256-oM6fXdXCWVcBnNrzXmF0ZMdp8j0pzkLE66WteeCutv8=";
            })
          ];
          });
        }
      )
    ];

    programs.emacs = {
      enable = true;
      package = pkgs.emacs29-pgtk;
    };

    services.emacs = {
      enable = true;
      client.enable = true;
      package = pkgs.emacs29-pgtk;
    };
  }
#+end_src
